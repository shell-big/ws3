name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ============================================================
  # Job 1: ShellCheck — setup.sh / delete.sh の文法チェック
  # ============================================================
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          shellcheck --severity=warning setup.sh
          shellcheck --severity=warning delete.sh

  # ============================================================
  # Job 2: Build — ARM64 ネイティブで navigator-lib + アプリをビルド
  # navigator-lib は cpy-binder の都合で nightly Rust が必須
  # ============================================================
  build:
    name: Build (ARM64)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      # --- システムパッケージ ---
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            cmake \
            build-essential \
            pkg-config \
            libi2c-dev \
            libgpiod-dev \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev

      # --- Rust nightly ---
      # navigator-lib の build.rs が -Zunpretty=expanded (nightly 専用) を使用するため
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      # --- navigator-lib のビルド ---
      - name: Clone navigator-lib
        run: |
          git clone https://github.com/bluerobotics/navigator-lib.git \
            "$HOME/navigator-lib"

      - name: Build navigator-lib
        working-directory: ${{ github.workspace }}
        run: |
          cd "$HOME/navigator-lib"
          cargo +nightly build
          echo "navigator-lib build complete"
          ls -la "$HOME/navigator-lib/target/debug/libbluerobotics_navigator"*

      # --- アプリケーションのビルド ---
      - name: Build navigator_control
        run: |
          make -f Makefile.mk \
            NAVIGATOR_LIB_PATH="$HOME/navigator-lib/target/debug"
          echo "App build complete"
          ls -la bin/navigator_control

      # --- ビルド成果物を保存（デバッグ用） ---
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: navigator_control-arm64
          path: bin/navigator_control
          retention-days: 7
